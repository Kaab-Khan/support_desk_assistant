╔══════════════════════════════════════════════════════════════════════════════════════════╗
║                     AI SUPPORT DESK ASSISTANT - TECHNICAL ARCHITECTURE                    ║
╚══════════════════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                                  CLIENT LAYER                                            │
│                         (External API Consumers / Streamlit UI)                          │
└──────────────────────────────────────────┬───────────────────────────────────────────────┘
                                           │
                                           ▼
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              API LAYER (main.py)                                         │
│  ┌─────────────────────────────────────────────────────────────────────────────────┐   │
│  │ FastAPI Application                                                              │   │
│  │ • title: "AI Support Desk Assistant"                                            │   │
│  │ • version: "0.1.0"                                                               │   │
│  └─────────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                          │
│  ENDPOINTS:                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────────────┐     │
│  │ POST /rag/query                                                                │     │
│  │   Input: RagQueryRequest {query: str}                                          │     │
│  │   Output: RagQueryResponse {answer: str, sources: [RagSource]}                 │     │
│  │   Function: rag_query() → Uses RAG service for knowledge-based Q&A            │     │
│  └───────────────────────────────────────────────────────────────────────────────┘     │
│  ┌───────────────────────────────────────────────────────────────────────────────┐     │
│  │ POST /summarise                                                                │     │
│  │   Input: SummariseRequest {text: str}                                          │     │
│  │   Output: SummariseResponse {summary: str, tags: [str]}                        │     │
│  │   Function: summarise_text() → Generates summary and extracts tags            │     │
│  └───────────────────────────────────────────────────────────────────────────────┘     │
│  ┌───────────────────────────────────────────────────────────────────────────────┐     │
│  │ POST /tickets/agent                                                            │     │
│  │   Input: TicketAgentRequest {ticket: str}                                      │     │
│  │   Output: TicketAgentResponse {id, action, reply, reason, tags}               │     │
│  │   Function: process_ticket() → AI-powered ticket triage & auto-reply          │     │
│  └───────────────────────────────────────────────────────────────────────────────┘     │
│  ┌───────────────────────────────────────────────────────────────────────────────┐     │
│  │ POST /tickets/feedback                                                         │     │
│  │   Input: TicketFeedbackRequest {ticket_id: int, human_label: str}             │     │
│  │   Output: TicketRecord                                                         │     │
│  │   Function: submit_ticket_feedback() → Human-in-the-loop feedback             │     │
│  └───────────────────────────────────────────────────────────────────────────────┘     │
│  ┌───────────────────────────────────────────────────────────────────────────────┐     │
│  │ GET /tickets?skip=0&limit=50                                                   │     │
│  │   Output: List[TicketRecord]                                                   │     │
│  │   Function: list_tickets() → Paginated ticket listing                          │     │
│  └───────────────────────────────────────────────────────────────────────────────┘     │
└──────────────────────────────────────────┬───────────────────────────────────────────────┘
                                           │
                    ┌──────────────────────┼──────────────────────┐
                    │                      │                       │
                    ▼                      ▼                       ▼
┌───────────────────────────┐ ┌───────────────────────┐ ┌────────────────────────┐
│  SERVICE LAYER            │ │  SERVICE LAYER        │ │  SERVICE LAYER         │
│  agent_service.py         │ │  rag_service.py       │ │  summariser.py         │
├───────────────────────────┤ ├───────────────────────┤ ├────────────────────────┤
│ TicketAgentService        │ │ RagService            │ │ SummariserService      │
│                           │ │                       │ │                        │
│ Methods:                  │ │ Methods:              │ │ Methods:               │
│ • process_ticket()        │ │ • answer()            │ │ • summarise()          │
│   - db: Session           │ │   - query: str        │ │   - text: str          │
│   - text: str             │ │   - top_k: int=5      │ │   - max_sentences:int=3│
│   - Returns: {            │ │   - Returns: {        │ │   - Returns: {         │
│     id, action, reply,    │ │     answer: str,      │ │     summary: str,      │
│     tags, reason}         │ │     sources: list}    │ │     tags: list}        │
│                           │ │                       │ │                        │
│ Dependencies:             │ │ Dependencies:         │ │ Uses:                  │
│ • RagService              │ │ • VectorStoreClient   │ │ • OpenAI API           │
│ • SummariserService       │ │ • OpenAI API          │ │   (gpt-4o-mini)        │
│ • CRUD operations         │ │   (gpt-4o-mini)       │ │                        │
│                           │ │                       │ │ Features:              │
│ Logic:                    │ │ Process:              │ │ • JSON-structured      │
│ 1. Get RAG answer         │ │ 1. Retrieve top_k     │ │   response             │
│ 2. Get summary/tags       │ │    documents from     │ │ • Tag extraction       │
│ 3. Decide action:         │ │    vectorstore        │ │ • Concise summaries    │
│    - "reply" if answer    │ │ 2. Build context      │ │                        │
│    - "escalate" otherwise │ │ 3. Call OpenAI with   │ │                        │
│ 4. Save to DB             │ │    context + query    │ │                        │
│                           │ │ 4. Return answer +    │ │                        │
│ Singleton:                │ │    source docs        │ │ Singleton:             │
│ get_ticket_agent_service()│ │                       │ │ get_summariser_service │
└──────────┬────────────────┘ │ Singleton:            │ └────────────────────────┘
           │                  │ get_rag_service()     │
           │                  └───────┬───────────────┘
           │                          │
           │                          ▼
           │         ┌────────────────────────────────────────┐
           │         │  VECTOR STORE LAYER                    │
           │         │  vectorstore.py                        │
           │         ├────────────────────────────────────────┤
           │         │ VectorStoreClient (Pinecone)           │
           │         │                                        │
           │         │ Methods:                               │
           │         │ • upsert_documents()                   │
           │         │   - texts: List[str]                   │
           │         │   - metadatas: List[Dict]              │
           │         │   - ids: List[str]                     │
           │         │                                        │
           │         │ • query_similar()                      │
           │         │   - query: str                         │
           │         │   - top_k: int=5                       │
           │         │   - filter: Dict                       │
           │         │   - Returns: List[{id, score,          │
           │         │              metadata}]                │
           │         │                                        │
           │         │ • _embed_texts() [private]             │
           │         │   - Uses OpenAI text-embedding-ada-002 │
           │         │   - Dimension: 1536                    │
           │         │                                        │
           │         │ Configuration:                         │
           │         │ • Index: Serverless (AWS us-east-1)    │
           │         │ • Metric: cosine similarity            │
           │         │ • Auto-creates index if missing        │
           │         │                                        │
           │         │ Singleton: get_vectorstore_client()    │
           │         └────────────────────────────────────────┘
           │                          │
           │                          ▼
           │         ┌────────────────────────────────────────┐
           │         │  EXTERNAL SERVICE                      │
           │         │  Pinecone Cloud Vector DB              │
           │         │  • Stores document embeddings          │
           │         │  • Semantic similarity search          │
           │         └────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────┐
│  DATA ACCESS LAYER                                          │
│  crud.py                                                    │
├─────────────────────────────────────────────────────────────┤
│ Database Operations (CRUD)                                  │
│                                                             │
│ Functions:                                                  │
│ • create_ticket()                                           │
│   - db: Session, text: str, action: str, reply: str,       │
│     tags: List[str], reason: str, human_label: str         │
│   - Returns: Ticket                                         │
│                                                             │
│ • get_ticket()                                              │
│   - db: Session, ticket_id: int                             │
│   - Returns: Optional[Ticket]                               │
│                                                             │
│ • list_tickets()                                            │
│   - db: Session, skip: int=0, limit: int=50                 │
│   - Returns: List[Ticket]                                   │
│                                                             │
│ • update_ticket_agent_result()                              │
│   - db: Session, ticket_id: int, action: str,               │
│     reply: str, tags: List[str], reason: str                │
│   - Returns: Optional[Ticket]                               │
│                                                             │
│ • update_ticket_feedback()                                  │
│   - db: Session, ticket_id: int, human_label: str           │
│   - Returns: Optional[Ticket]                               │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  DATABASE LAYER                                             │
│  db.py + models.py                                          │
├─────────────────────────────────────────────────────────────┤
│ db.py - Connection Management                               │
│ • Base = declarative_base()                                 │
│ • engine = create_engine(DB_URL)                            │
│ • SessionLocal = sessionmaker()                             │
│ • get_db() - FastAPI dependency for sessions                │
│                                                             │
│ models.py - ORM Models                                      │
│ ┌─────────────────────────────────────────────────────┐    │
│ │ Ticket Model (Table: "tickets")                     │    │
│ │ • id: Integer (PK, indexed)                         │    │
│ │ • text: Text (NOT NULL) - ticket content            │    │
│ │ • action: String (NOT NULL) - reply/escalate/close  │    │
│ │ • reply: Text (nullable) - AI-generated reply       │    │
│ │ • tags: String (nullable) - comma-separated tags    │    │
│ │ • reason: Text (nullable) - action justification    │    │
│ │ • created_at: DateTime (default: now())             │    │
│ │ • human_label: String (nullable) - feedback         │    │
│ └─────────────────────────────────────────────────────┘    │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
               ┌───────────────────────┐
               │  SQLite Database      │
               │  data/support.db      │
               └───────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  CONFIGURATION & SCHEMAS                                    │
├─────────────────────────────────────────────────────────────┤
│ config.py                                                   │
│ ├─ Settings (pydantic-settings)                             │
│ │  • OPENAI_API_KEY: str                                    │
│ │  • PINECONE_API_KEY: str                                  │
│ │  • PINECONE_INDEX_NAME: str                               │
│ │  • DB_URL: str = "sqlite:///data/support.db"              │
│ │  • DOCS_DIR: str = "data/docs"                            │
│ │  • VECTORSTORE_DIR: str = "data/vectorstore"              │
│ │  • env_file: ".env"                                       │
│ └─ get_settings() - Singleton with @lru_cache               │
│                                                             │
│ schemas.py (Pydantic Models)                                │
│ ├─ Request Models:                                          │
│ │  • RagQueryRequest {query: str}                           │
│ │  • SummariseRequest {text: str}                           │
│ │  • TicketAgentRequest {ticket: str}                       │
│ │  • TicketFeedbackRequest {ticket_id: int,                 │
│ │                           human_label: str}               │
│ └─ Response Models:                                         │
│    • RagQueryResponse {answer: str, sources: [RagSource]}   │
│    • RagSource {doc_name: str, snippet: str}                │
│    • SummariseResponse {summary: str, tags: [str]}          │
│    • TicketAgentResponse {id: int, action: str,             │
│                           reply: str, reason: str,          │
│                           tags: [str]}                      │
│    • TicketRecord {id, text, action, reply, tags,           │
│                    reason, created_at, human_label}         │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│  EXTERNAL INTEGRATIONS                                      │
├─────────────────────────────────────────────────────────────┤
│ • OpenAI API                                                │
│   - gpt-4o-mini (chat completions)                          │
│   - text-embedding-ada-002 (embeddings, 1536 dimensions)    │
│                                                             │
│ • Pinecone Vector Database                                  │
│   - Serverless deployment (AWS us-east-1)                   │
│   - Cosine similarity metric                                │
└─────────────────────────────────────────────────────────────┘

╔═══════════════════════════════════════════════════════════════╗
║                      DATA FLOW EXAMPLES                        ║
╚═══════════════════════════════════════════════════════════════╝

1. TICKET PROCESSING FLOW:
   Client → POST /tickets/agent {ticket: "..."}
   → TicketAgentService.process_ticket()
      → RagService.answer() 
         → VectorStoreClient.query_similar()
            → Pinecone (semantic search)
         → OpenAI API (generate answer with context)
      → SummariserService.summarise()
         → OpenAI API (extract tags)
      → crud.create_ticket()
         → SQLite DB (persist ticket)
   → Return TicketAgentResponse

2. RAG QUERY FLOW:
   Client → POST /rag/query {query: "..."}
   → RagService.answer()
      → VectorStoreClient.query_similar()
         → OpenAI embeddings API
         → Pinecone search
      → OpenAI chat API (with retrieved context)
   → Return RagQueryResponse {answer, sources}

3. FEEDBACK FLOW:
   Client → POST /tickets/feedback {ticket_id, human_label}
   → crud.update_ticket_feedback()
      → SQLite DB (update ticket.human_label)
   → Return updated TicketRecord

